(function(){"use strict";function H(t){return t==="binary"?1:t==="octal"?3:4}function z(t,e){const o=[...t.replace(/\s+/g,"")];return e==="hex"?o.map(r=>parseInt(r,16)):o.map(r=>{const s=r.charCodeAt(0)-48;return s<0?0:s})}function k(t,e,n){if(t.length<2)return"";const o=[];if(n.circular){const i=t.length,a=e;for(let l=0;l<i;l++){const f=t[l],b=(t[(l+1)%i]-f+a)%a||a;o.push(b)}}else{for(let i=0;i<t.length-1;i++)o.push(t[i+1]-t[i]);if(o.length<3)return""}const r=N(o,n.circular),s=[r];if(n.rotationInvariant&&s.push(...O(r)),n.reflectionInvariant){const i=P(r);s.push(i,...O(i))}return T(s)}function G(t,e,n){if(t.length<2)return"";const o=[];if(n.circular){const l=t.length,f=e;for(let d=0;d<l;d++){const b=t[d],M=(t[(d+1)%l]-b+f)%f||f;o.push(M)}}else{for(let l=0;l<t.length-1;l++)o.push(t[l+1]-t[l]);if(o.length<2)return""}const r=o.length,s=new Array(r);for(let l=0;l<r;l++){const f=o[(l-1+r)%r],d=o[l];s[l]=f+d}const i=N(s,n.circular),a=[i];if(n.rotationInvariant&&a.push(...O(i)),n.reflectionInvariant){const l=P(i);a.push(l,...O(l))}return T(a)}function N(t,e){const n=[],o=t.length,r=e?o:o-1;for(let s=0;s<r;s++){const i=t[s],a=t[(s+1)%o];n.push(a===i?"S":a>i?"U":"D")}return n.join("")}function O(t){const e=[];for(let n=1;n<t.length;n++)e.push(t.slice(n)+t.slice(0,n));return e}function P(t){const e=n=>n==="U"?"D":n==="D"?"U":"S";return t.split("").reverse().map(e).join("")}function T(t){let e=t[0];for(const n of t)n<e&&(e=n);return e}function I(t,e){if(t.length<2)return[];const n=[],o=t.length;for(let r=0;r<o;r++){const s=t[r],a=(t[(r+1)%o]-s+e)%e||e;n.push(a)}return n}function W(t,e){if(t.length===0)return!1;if(t.length===1)return!0;const n=t.length,o=I(t,e),r=Math.floor(e/n),s=Math.ceil(e/n),i=e%n;let a=0,l=0;for(const f of o)if(f===r)a++;else if(f===s)l++;else return!1;return l===i&&a===n-i}function F(t,e){if(e%2!==0)return!0;const n=e/2,o=t.length;if(o===0)return!0;const r=t.concat(t);for(let s=0;s<o;s++){let i=0;for(let a=1;a<o;a++){if(i+=r[s+a-1],i===n)return!1;if(i>n)break}}return!0}function _(t,e){if(t.length<2||e%2!==0)return!1;const n=I(t,e);for(const o of n)if(o!==2&&o!==3)return!1;return F(n,e)}function Y(t,e){if(t.length<2||e%2!==0)return!1;const n=I(t,e);for(const o of n)if(o%2===0)return!1;return F(n,e)}function Z(t,e){if(e%2!==0)return!0;const n=e/2,o=new Set(t);for(const r of t){const s=(r+n)%e;if(o.has(s))return!1}return!0}function $(t){return t<=0?0:Math.floor((Math.sqrt(1+8*t)-1)/2)}function J(t){const e=t.length;if(e===0)return 0;const n=new Map;for(const r of t)n.set(r,(n.get(r)??0)+1);let o=0;for(const[,r]of n){const s=r/e;o+=s*Math.log(s)}return o===0?0:-o}const j=new Map;function K(t,e){if(t.length<2){let s=j.get(e);return s===void 0&&(s=Math.log($(e)*.5),j.set(e,s)),0<s}const n=I(t,e),o=J(n);let r=j.get(e);return r===void 0&&(r=Math.log($(e)*.5),j.set(e,r)),o<r}function R(t,e){const n=Math.floor(e/2);if(n<=0)return[];const o=new Array(n).fill(0),r=new Uint8Array(e);for(const s of t)s>=0&&s<e&&(r[s]=1);for(let s=1;s<=n;s++){let i=0;for(let a=0;a<e;a++)r[a]&&r[(a+s)%e]&&i++;s===n&&e%2===0&&(i=Math.floor(i/2)),o[s-1]=i}return o}function U(t,e){const n=R(t,e);if(n.length===0)return!0;const o=[];for(let r=0;r<n.length;r++)n[r]!==0&&o.push(r);if(o.length<=1)return!0;for(let r=0;r<o.length-1;r++)if(o[r+1]-o[r]!==1)return!1;return!0}function Q(t,e){if(t<0||e<0||e>t)throw new Error("Invalid n,k for binomial");e>t-e&&(e=t-e);let n=1;for(let o=0;o<e;o++)n=n*(t-o)/(o+1);return n}function X(t){return Q(t+1,2)}function L(t,e){if(!U(t,e))return!1;const n=t.length;if(n<1)return!1;const r=R(t,e).filter(a=>a!==0),s=r.length;if(s===0)return!1;const i=X(n)/s;for(const a of r)if(Math.abs(a-i)>.5*i)return!1;return!0}function tt(t){const e=[];for(let n=1;n*n<=t;n++)t%n===0&&(e.push(n),n*n!==t&&e.push(t/n));return e.sort((n,o)=>n-o)}const V=new Map;function nt(t){const e=new Set,n="0".repeat(t);e.add(n);for(const o of tt(t)){const r=Math.floor(t/o);for(let s=1;s<=r;s++){const i=new Array(t).fill(0),a=new Array(t).fill(0);for(let l=0;l<s;l++){i[l*o]=1;const f=t-(l+1)*o;f>=0&&f<t&&(a[f]=1)}e.add(i.join("")),e.add(a.join(""))}}return e}function et(t,e,n){if(n<2||e%n!==0)return!1;let o=V.get(n);o||(o=nt(n),V.set(n,o));const r=new Array(e).fill("0");for(const a of t)a>=0&&a<e&&(r[a]="1");const s=r.slice().reverse().join(""),i=e/n;for(let a=0;a<i;a++){const l=s.slice(a*n,(a+1)*n);if(!o.has(l))return!1}return!0}let w=!1;self.onmessage=t=>{const e=t.data;if(e.type==="stop"){w=!0;return}e.type==="start"&&(w=!1,it(e.payload).catch(()=>{}))};function ot(t,e){const n=H(e),o=t.length*n,r=[],s=(1<<n)-1;for(let i=0;i<t.length;i++){const a=Math.max(0,Math.min(t[i],s)),l=i*n;for(let f=0;f<n;f++)a>>n-1-f&1&&r.push(l+f)}return{onsets:r,totalBits:o}}function rt(t,e){return t.length===0?e.join(" "):e.length===0?t.join(" "):t.join(" ")+" "+e.join(" ")}function st(t){return(t||"").trim().split(/\s+/).filter(Boolean)}async function it(t){const e=t.items,n=new Map,o=new Map;for(const p of e){const M=Math.max(1,Math.floor(Number(p.numerator))),y=Math.max(1,Math.floor(Number(p.denominator))),m=`${p.base}|${M}/${y}`;n.has(m)||n.set(m,[]),n.get(m).push(p),o.has(m)||o.set(m,{base:p.base,num:M,den:y})}const r=200,s=2e3;let i=0,a=0,l=[],f=0;for(const p of n.values())f+=p.length*p.length;self.postMessage({type:"meta",totalPairs:f});const d=()=>{l.length&&(self.postMessage({type:"batch",items:l}),l=[])},b={circular:t.circular,rotationInvariant:t.rotationInvariant,reflectionInvariant:t.reflectionInvariant};for(const[p,M]of n.entries()){if(w)break;const y=o.get(p),m=M.map(h=>{const v=z(h.groupedDigitsString,h.base),{onsets:E,totalBits:u}=ot(v,h.base);return{a:h,groups:st(h.groupedDigitsString),onsets:E,totalBits:u}});let B=0,C=0,D=Date.now();const q=16;for(;!w&&B<m.length;){for(;!w&&C<m.length;){const h=m[B],v=m[C],E=h.totalBits,u=new Array(h.onsets.length+v.onsets.length);for(let c=0;c<h.onsets.length;c++)u[c]=h.onsets[c];for(let c=0;c<v.onsets.length;c++)u[h.onsets.length+c]=v.onsets[c]+E;const g=h.totalBits+v.totalBits,x=u.length,at=typeof t.minOnsets=="number"?t.minOnsets:0,lt=typeof t.maxOnsets=="number"?t.maxOnsets:g;if(x>=at&&x<=lt){let c=!0;if(t.excludeTrivial&&(x===0||x===g)&&(c=!1),c&&t.onlyIsomorphic){const S=k(u,g,b),A=G(u,g,b);c=S.length>0&&S===A}if(c&&t.onlyMaximallyEven&&(c=W(u,g)),c&&t.oddityType!=="off")switch(t.oddityType){case"rop23":c=_(u,g);break;case"odd-intervals":c=Y(u,g);break;case"no-antipodes":c=Z(u,g);break}if(c&&t.onlyLowEntropy&&(c=K(u,g)),c&&t.onlyHasNoGaps&&(c=U(u,g)),c&&t.onlyRelativelyFlat&&(c=L(u,g)),c&&t.ordinalEnabled&&t.ordinalN&&t.ordinalN>=2&&(c=et(u,g,t.ordinalN)),c){const S=typeof t.retentionProbability=="number"?Math.max(0,Math.min(1,t.retentionProbability)):1;if(!(Math.random()>S)){const A=rt(h.groups,v.groups),ct=k(u,g,b);l.push({id:`aggl:${y.base}:${A}:${a}`,base:y.base,groupedDigitsString:A,onsets:x,canonicalContour:ct,numerator:y.num*2,denominator:y.den}),a++,l.length>=r&&d()}}}i++,(i%s===0||Date.now()-D>q)&&(self.postMessage({type:"progress",processed:i,emitted:a}),await new Promise(c=>setTimeout(c,0)),D=Date.now()),C++}B++,C=0,Date.now()-D>q&&(self.postMessage({type:"progress",processed:i,emitted:a}),await new Promise(h=>setTimeout(h,0)),D=Date.now())}}d(),self.postMessage({type:"progress",processed:i,emitted:a}),self.postMessage({type:"done"})}})();
