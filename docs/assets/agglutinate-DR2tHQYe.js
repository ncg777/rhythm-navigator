(function(){"use strict";function H(t){return t==="binary"?1:t==="octal"?3:4}function z(t,e){const o=[...t.replace(/\s+/g,"")];return e==="hex"?o.map(r=>parseInt(r,16)):o.map(r=>{const s=r.charCodeAt(0)-48;return s<0?0:s})}function N(t,e,n){if(t.length<2)return"";const o=[];if(n.circular){const i=t.length,l=e;for(let a=0;a<i;a++){const f=t[a],b=(t[(a+1)%i]-f+l)%l||l;o.push(b)}}else{for(let i=0;i<t.length-1;i++)o.push(t[i+1]-t[i]);if(o.length<3)return""}const r=k(o,n.circular),s=[r];if(n.rotationInvariant&&s.push(...x(r)),n.reflectionInvariant){const i=T(r);s.push(i,...x(i))}return P(s)}function G(t,e,n){if(t.length<2)return"";const o=[];if(n.circular){const a=t.length,f=e;for(let d=0;d<a;d++){const b=t[d],w=(t[(d+1)%a]-b+f)%f||f;o.push(w)}}else{for(let a=0;a<t.length-1;a++)o.push(t[a+1]-t[a]);if(o.length<2)return""}const r=o.length,s=new Array(r);for(let a=0;a<r;a++){const f=o[(a-1+r)%r],d=o[a];s[a]=f+d}const i=k(s,n.circular),l=[i];if(n.rotationInvariant&&l.push(...x(i)),n.reflectionInvariant){const a=T(i);l.push(a,...x(a))}return P(l)}function k(t,e){const n=[],o=t.length,r=e?o:o-1;for(let s=0;s<r;s++){const i=t[s],l=t[(s+1)%o];n.push(l===i?"S":l>i?"U":"D")}return n.join("")}function x(t){const e=[];for(let n=1;n<t.length;n++)e.push(t.slice(n)+t.slice(0,n));return e}function T(t){const e=n=>n==="U"?"D":n==="D"?"U":"S";return t.split("").reverse().map(e).join("")}function P(t){let e=t[0];for(const n of t)n<e&&(e=n);return e}function C(t,e){if(t.length<2)return[];const n=[],o=t.length;for(let r=0;r<o;r++){const s=t[r],l=(t[(r+1)%o]-s+e)%e||e;n.push(l)}return n}function W(t,e){if(t.length===0)return!1;if(t.length===1)return!0;const n=t.length,o=C(t,e),r=Math.floor(e/n),s=Math.ceil(e/n),i=e%n;let l=0,a=0;for(const f of o)if(f===r)l++;else if(f===s)a++;else return!1;return a===i&&l===n-i}function F(t,e){if(e%2!==0)return!0;const n=e/2,o=t.length;if(o===0)return!0;const r=t.concat(t);for(let s=0;s<o;s++){let i=0;for(let l=1;l<o;l++){if(i+=r[s+l-1],i===n)return!1;if(i>n)break}}return!0}function _(t,e){if(t.length<2||e%2!==0)return!1;const n=C(t,e);for(const o of n)if(o!==2&&o!==3)return!1;return F(n,e)}function Y(t,e){if(t.length<2||e%2!==0)return!1;const n=C(t,e);for(const o of n)if(o%2===0)return!1;return F(n,e)}function Z(t,e){if(e%2!==0)return!0;const n=e/2,o=new Set(t);for(const r of t){const s=(r+n)%e;if(o.has(s))return!1}return!0}function $(t){return t<=0?0:Math.floor((Math.sqrt(1+8*t)-1)/2)}function J(t){const e=t.length;if(e===0)return 0;const n=new Map;for(const r of t)n.set(r,(n.get(r)??0)+1);let o=0;for(const[,r]of n){const s=r/e;o+=s*Math.log(s)}return o===0?0:-o}const D=new Map;function K(t,e){if(t.length<2){let s=D.get(e);return s===void 0&&(s=Math.log($(e)*.5),D.set(e,s)),0<s}const n=C(t,e),o=J(n);let r=D.get(e);return r===void 0&&(r=Math.log($(e)*.5),D.set(e,r)),o<r}function R(t,e){const n=Math.floor(e/2);if(n<=0)return[];const o=new Array(n).fill(0),r=new Uint8Array(e);for(const s of t)s>=0&&s<e&&(r[s]=1);for(let s=1;s<=n;s++){let i=0;for(let l=0;l<e;l++)r[l]&&r[(l+s)%e]&&i++;s===n&&e%2===0&&(i=Math.floor(i/2)),o[s-1]=i}return o}function U(t,e){const n=R(t,e);if(n.length===0)return!0;const o=[];for(let r=0;r<n.length;r++)n[r]!==0&&o.push(r);if(o.length<=1)return!0;for(let r=0;r<o.length-1;r++)if(o[r+1]-o[r]!==1)return!1;return!0}function Q(t,e){if(t<0||e<0||e>t)throw new Error("Invalid n,k for binomial");e>t-e&&(e=t-e);let n=1;for(let o=0;o<e;o++)n=n*(t-o)/(o+1);return n}function X(t){return Q(t+1,2)}function L(t,e){if(!U(t,e))return!1;const n=t.length;if(n<1)return!1;const r=R(t,e).filter(l=>l!==0),s=r.length;if(s===0)return!1;const i=X(n)/s;for(const l of r)if(Math.abs(l-i)>.5*i)return!1;return!0}function tt(t){const e=[];for(let n=1;n*n<=t;n++)t%n===0&&(e.push(n),n*n!==t&&e.push(t/n));return e.sort((n,o)=>n-o)}const V=new Map;function nt(t){const e=new Set,n="0".repeat(t);e.add(n);for(const o of tt(t)){const r=Math.floor(t/o);for(let s=1;s<=r;s++){const i=new Array(t).fill(0),l=new Array(t).fill(0);for(let a=0;a<s;a++){i[a*o]=1;const f=t-(a+1)*o;f>=0&&f<t&&(l[f]=1)}e.add(i.join("")),e.add(l.join(""))}}return e}function et(t,e,n){if(n<2||e%n!==0)return!1;let o=V.get(n);o||(o=nt(n),V.set(n,o));const r=new Array(e).fill("0");for(const l of t)l>=0&&l<e&&(r[l]="1");const s=r.slice().reverse().join(""),i=e/n;for(let l=0;l<i;l++){const a=s.slice(l*n,(l+1)*n);if(!o.has(a))return!1}return!0}let M=!1;self.onmessage=t=>{const e=t.data;if(e.type==="stop"){M=!0;return}e.type==="start"&&(M=!1,it(e.payload).catch(()=>{}))};function ot(t,e){const n=H(e),o=t.length*n,r=[],s=(1<<n)-1;for(let i=0;i<t.length;i++){const l=Math.max(0,Math.min(t[i],s)),a=i*n;for(let f=0;f<n;f++)l>>n-1-f&1&&r.push(a+f)}return{onsets:r,totalBits:o}}function rt(t,e){return t.length===0?e.join(" "):e.length===0?t.join(" "):t.join(" ")+" "+e.join(" ")}function st(t){return(t||"").trim().split(/\s+/).filter(Boolean)}async function it(t){const e=t.items,n=new Map,o=new Map;for(const p of e){const w=Math.max(1,Math.floor(Number(p.numerator))),v=Math.max(1,Math.floor(Number(p.denominator))),m=`${p.base}|${w}/${v}`;n.has(m)||n.set(m,[]),n.get(m).push(p),o.has(m)||o.set(m,{base:p.base,num:w,den:v})}const r=200,s=2e3;let i=0,l=0,a=[],f=0;for(const p of n.values())f+=p.length*p.length;self.postMessage({type:"meta",totalPairs:f});const d=()=>{a.length&&(self.postMessage({type:"batch",items:a}),a=[])},b={circular:t.circular,rotationInvariant:t.rotationInvariant,reflectionInvariant:t.reflectionInvariant};for(const[p,w]of n.entries()){if(M)break;const v=o.get(p),m=w.map(h=>{const y=z(h.groupedDigitsString,h.base),{onsets:B,totalBits:u}=ot(y,h.base);return{a:h,groups:st(h.groupedDigitsString),onsets:B,totalBits:u}});let A=0,S=0,O=Date.now();const q=16;for(;!M&&A<m.length;){for(;!M&&S<m.length;){const h=m[A],y=m[S],B=h.totalBits,u=new Array(h.onsets.length+y.onsets.length);for(let c=0;c<h.onsets.length;c++)u[c]=h.onsets[c];for(let c=0;c<y.onsets.length;c++)u[h.onsets.length+c]=y.onsets[c]+B;const g=h.totalBits+y.totalBits,I=u.length;if(I>=t.minOnsets&&I<=t.maxOnsets){let c=!0;if(t.excludeTrivial&&(I===0||I===g)&&(c=!1),c&&t.onlyIsomorphic){const j=N(u,g,b),E=G(u,g,b);c=j.length>0&&j===E}if(c&&t.onlyMaximallyEven&&(c=W(u,g)),c&&t.oddityType!=="off")switch(t.oddityType){case"rop23":c=_(u,g);break;case"odd-intervals":c=Y(u,g);break;case"no-antipodes":c=Z(u,g);break}if(c&&t.onlyLowEntropy&&(c=K(u,g)),c&&t.onlyHasNoGaps&&(c=U(u,g)),c&&t.onlyRelativelyFlat&&(c=L(u,g)),c&&t.ordinalEnabled&&t.ordinalN&&t.ordinalN>=2&&(c=et(u,g,t.ordinalN)),c){const j=rt(h.groups,y.groups),E=N(u,g,b);a.push({id:`aggl:${v.base}:${j}:${l}`,base:v.base,groupedDigitsString:j,onsets:I,canonicalContour:E,numerator:v.num*2,denominator:v.den}),l++,a.length>=r&&d()}}i++,(i%s===0||Date.now()-O>q)&&(self.postMessage({type:"progress",processed:i,emitted:l}),await new Promise(c=>setTimeout(c,0)),O=Date.now()),S++}A++,S=0,Date.now()-O>q&&(self.postMessage({type:"progress",processed:i,emitted:l}),await new Promise(h=>setTimeout(h,0)),O=Date.now())}}d(),self.postMessage({type:"progress",processed:i,emitted:l}),self.postMessage({type:"done"})}})();
